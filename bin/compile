#!/bin/sh

BUILD_DIR=$1
CACHE_DIR=$2

INSTALL_DIR="$BUILD_DIR/vendor"
mkdir -p "$INSTALL_DIR"

export PATH="$INSTALL_DIR/bin:$PATH"
export LD_LIBRARY_PATH="$INSTALL_DIR/lib:${LD_LIBRARY_PATH:-}"
export PKG_CONFIG_PATH="$INSTALL_DIR/lib/pkgconfig:${PKG_CONFIG_PATH:-}"

# Install build tools
echo "[INFO] Installing build tools..."
apt-get update -qq
apt-get install -y --no-install-recommends \
  build-essential \
  ca-certificates \
  curl \
  pkg-config \
  autoconf automake libtool \
  cmake ninja-build \
  > /dev/null

# Create temp dir
TMP_DIR=$(mktemp -d)
cd "$TMP_DIR"

# Final environment configuration
export MAGICK_CONFIGURE_PATH="$INSTALL_DIR/etc/ImageMagick-7"

########################################
# libde265 (HEVC decoder)
#
# Your build failed because libheif is building a shared library (libheif.so)
# and it attempted to link in a non-PIC static libde265.a.
#
# Fix: build libde265 as a shared library (or build static with -fPIC).
# Shared is simplest and avoids the relocation error.
########################################

echo "[INFO] Building libde265..."
LIBDE265_VERSION=1.0.8
curl -sL "https://github.com/strukturag/libde265/archive/refs/tags/v${LIBDE265_VERSION}.tar.gz" -o libde265.tar.gz
mkdir libde265 && tar -xzf libde265.tar.gz -C libde265 --strip-components=1
cd libde265
./autogen.sh

# Build shared libde265.so (preferred)
export CFLAGS="-fPIC"
export CXXFLAGS="-fPIC"
./configure --prefix="$INSTALL_DIR" \
  --enable-shared --disable-static \
  --quiet
make -s -j4 > "$BUILD_DIR/make-libde265.log" 2>&1
make -s install >> "$BUILD_DIR/make-libde265.log" 2>&1

# Reset flags so they do not leak into the next builds
unset CFLAGS || true
unset CXXFLAGS || true

cd "$TMP_DIR"

########################################
# libheif (HEIF container)
########################################

echo "[INFO] Building libheif..."
LIBHEIF_VERSION=1.18.0
curl -sL "https://github.com/strukturag/libheif/releases/download/v${LIBHEIF_VERSION}/libheif-${LIBHEIF_VERSION}.tar.gz" -o libheif.tar.gz
mkdir libheif && tar -xzf libheif.tar.gz -C libheif --strip-components=1
cd libheif
mkdir build && cd build

cmake -Wno-dev \
  -DCMAKE_INSTALL_PREFIX="$INSTALL_DIR" \
  -DCMAKE_BUILD_TYPE=Release \
  -DCMAKE_PREFIX_PATH="$INSTALL_DIR" \
  -DWITH_GDK_PIXBUF=OFF \
  -DWITH_LIBDE265=ON \
  -DENABLE_PLUGIN_LOADING=OFF \
  .. > "$BUILD_DIR/cmake-libheif.log" 2>&1

make -s -j4 > "$BUILD_DIR/make-libheif.log" 2>&1
make -s install >> "$BUILD_DIR/make-libheif.log" 2>&1

cd "$TMP_DIR"

# Confirm libheif.pc exists
if [ ! -f "$INSTALL_DIR/lib/pkgconfig/libheif.pc" ]; then
  echo "[ERROR] libheif.pc not found. HEIC support may not be detected."
  exit 1
fi

########################################
# ImageMagick
########################################

echo "[INFO] Building ImageMagick with HEIC support..."
curl -sL https://imagemagick.org/archive/ImageMagick.tar.gz -o ImageMagick.tar.gz
mkdir imagemagick && tar -xzf ImageMagick.tar.gz -C imagemagick --strip-components=1
cd imagemagick

export CFLAGS="-I$INSTALL_DIR/include"
export LDFLAGS="-L$INSTALL_DIR/lib"
export PKG_CONFIG_PATH="$INSTALL_DIR/lib/pkgconfig:${PKG_CONFIG_PATH:-}"

./configure \
  --prefix="$INSTALL_DIR" \
  --enable-shared \
  --disable-static \
  --with-heic=yes \
  > "$BUILD_DIR/configure-imagemagick.log" 2>&1 || {
    echo "[ERROR] ImageMagick configure failed. Showing tail of config log:"
    tail -n 200 "$BUILD_DIR/configure-imagemagick.log" || true
    exit 1
  }

make -s -j4 > "$BUILD_DIR/make-imagemagick.log" 2>&1
make -s install >> "$BUILD_DIR/make-imagemagick.log" 2>&1

########################################
# Verify during build
########################################

echo "[INFO] Verifying ImageMagick HEIC support..."
"$INSTALL_DIR/bin/magick" -version || true
"$INSTALL_DIR/bin/magick" -list format | grep -i heic || true
ldd "$INSTALL_DIR/bin/magick" | grep -E "libheif|libde265" || true

########################################
# Runtime environment (Heroku dynos)
########################################

mkdir -p "$BUILD_DIR/.profile.d"
cat > "$BUILD_DIR/.profile.d/imagemagick.sh" <<'EOF'
export PATH="$HOME/vendor/bin:$PATH"
export LD_LIBRARY_PATH="$HOME/vendor/lib:${LD_LIBRARY_PATH}"
export MAGICK_CONFIGURE_PATH="$HOME/vendor/etc/ImageMagick-7"
export PKG_CONFIG_PATH="$HOME/vendor/lib/pkgconfig:${PKG_CONFIG_PATH}"
EOF

# Optional debug signal
"$INSTALL_DIR/bin/magick" -debug configure -list format 2>&1 | grep -i heic || true
